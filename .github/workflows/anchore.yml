name: Docker Security Scan

on:
  push:
    branches: 
      - testing

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v1

#     # debian
#     - name: Build debian image
#       id: build_debian
#       run: docker build -f base/debian/Dockerfile -t srijanlabs/debian:latest base/debian
#     - name: Scan debian image
#       id: scan_debian
#       uses: anchore/scan-action@master
#       with:
#         image-reference: "srijanlabs/debian:latest"
#         dockerfile-path: "base/debian/Dockerfile"
#         fail-build: false
#         acs-report-enable: true
#     - name: print anchore output
#       id: scan_debian_output
#       run: |
#         echo "${{ steps.scan_debian.outputs.vulnerabilities }}"
#         echo "${{ steps.scan_debian.outputs.policycheck }}"

#     # apache
#     - name: Build apache image
#       id: build_apache
#       run: docker build -f apache/debian/Dockerfile -t srijanlabs/apache:latest apache/debian
#     - name: Scan apache image
#       id: scan_apache
#       uses: anchore/scan-action@master
#       with:
#         image-reference: "srijanlabs/apache:latest"
#         dockerfile-path: "apache/debian/Dockerfile"
#         fail-build: false
#         acs-report-enable: true

#     # php-base
#     - name: Build php image
#       id: build_php
#       run: docker build -f php/debian/base/Dockerfile -t srijanlabs/php:latest php/debian/base
#     - name: Scan php image
#       id: scan_php
#       uses: anchore/scan-action@master
#       with:
#         image-reference: "srijanlabs/php:latest"
#         dockerfile-path: "php/debian/base/Dockerfile"
#         fail-build: false
#         acs-report-enable: true

#     # php-cli
#     - name: Build php-cli image
#       id: build_php_cli
#       run: docker build -f php/debian/cli/Dockerfile -t srijanlabs/php-cli:latest php/debian/cli
#     - name: Scan php-cli image
#       id: scan_php_cli
#       uses: anchore/scan-action@master
#       with:
#         image-reference: "srijanlabs/php-cli:latest"
#         dockerfile-path: "php/debian/cli/Dockerfile"
#         fail-build: false
#         acs-report-enable: true
#     - name: print anchore output
#       id: scan_php_cli_output
#       run: |
#         echo "${{ steps.scan_php_cli.outputs.vulnerabilities }}"
#         echo "${{ steps.scan_php_cli.outputs.policycheck }}"

    # php-dev
    - name: Build php-dev image
      id: build_php_dev
      run: docker build -f php/debian/dev/Dockerfile -t srijanlabs/php-dev:latest php/debian/dev
    - name: Scan php-dev image
      id: scan_php_dev
      uses: anchore/scan-action@master
      with:
        image-reference: "srijanlabs/php-dev:latest"
        dockerfile-path: "php/debian/dev/Dockerfile"
        fail-build: false
        # acs-report-enable: true
    - name: Rename file
      run: mv ./anchore-reports/vulnerabilities.json ./anchore-reports/vulnerabilities-php-dev.json
    - name: list files
      run: ls ./anchore-reports/vulnerabilities-*.json
    - name: anchore inline scan JSON results
      run: for j in `ls ./anchore-reports/vulnerabilities-*.json`; do echo "---- ${j} ----"; cat ${j}; echo; done
    # - name: anchore action SARIF report
    #   run: cat results.sarif
    # - name: upload Anchore scan SARIF report
    #   uses: github/codeql-action/upload-sarif@v1
    #   with:
    #     sarif_file: results.sarif 
#     - name: print anchore output
#       id: scan_php_dev_output
#       run: |
#         echo "${{ steps.scan_php_dev.outputs.vulnerabilities }}"
#         echo "${{ steps.scan_php_dev.outputs.policycheck }}" 
    - name: Raise issue
      id: raise_issue_php_dev
#       if: contains(steps.scan_php_dev.outputs.policycheck, 'pass')
      uses: WSMathias/create-an-issue@v2.1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        IMAGE: srijanlabs/php-dev:latest
      
        
#     # php-fpm
#     - name: Build php-fpm image
#       id: build_php_fpm
#       run: docker build -f php/debian/fpm/Dockerfile -t srijanlabs/php-fpm:latest php/debian/fpm
#     - name: Scan php-fpm image
#       id: scan_php_fpm
#       uses: anchore/scan-action@master
#       with:
#         image-reference: "srijanlabs/php-fpm:latest"
#         dockerfile-path: "php/debian/fpm/Dockerfile"
#         fail-build: false
#         acs-report-enable: true

#     # php-fpm-apache
#     - name: Build php-fpm-apache image
#       id: build_php_fpm_apache
#       run: docker build -f php-fpm-apache/debian/Dockerfile -t srijanlabs/php-fpm-apache:latest php-fpm-apache/debian
#     - name: Scan php-fpm-apache image
#       id: scan_php_fpm_apache
#       uses: anchore/scan-action@master
#       with:
#         image-reference: "srijanlabs/php-fpm-apache:latest"
#         dockerfile-path: "php-fpm-apache/debian/Dockerfile"
#         fail-build: false
#         acs-report-enable: true

